swagger: '2.0'

info:
  version: 3.0.0
  title: Website API
  description: >-
    Shiny new Codacy API
  contact:
    name: Codacy Team
    email: code@codacy.com
    url: https://www.codacy.com
  license:
    name: Codacy. All rights reserved
    url: https://www.codacy.com

schemes:
  - https

host: app.codacy.com

basePath: /api/v3

produces:
  - application/json
consumes:
  - application/json

securityDefinitions:
  ApiKeyAuth:
    type: apiKey
    in: header
    name: api-token

definitions:
  Visibility:
    type: string
    x-ms-enum:
      name: "Visibility"
    enum: &visibilityEnum
      - Public
      - Private
      - LoginPublic

  Provider:
    type: string
    x-ms-enum:
      name: "Provider"
    enum: &providerEnum
      - manual
      - bb
      - bbe
      - gh
      - ghe
      - gl
      - gle

  AccountProvider:
    type: string
    x-ms-enum:
      name: "AccountProvider"
    enum: &accountProviderEnum
      - github-enterprise
      - github
      - google
      - bitbucket
      - bitbucket-server
      - gitlab
      - gitlab-enterprise

  JoinMode:
    type: string
    x-ms-enum:
      name: "JoinMode"
    enum:
      - auto
      - adminAuto
      - request

  HealthCheck:
    type: object
    required:
      - message
    properties:
      message:
        type: string
    example:
      message: "Hello, it's me"

  HealthCheckResponse:
    type: object
    required:
      - data
    properties:
      data:
        $ref: "#/definitions/HealthCheck"

  PaginationInfo:
    type: object
    properties:
      cursor:
        type: string
      limit:
        type: integer
        format: int32
      total:
        type: integer
        format: int32

  User:
    type: object
    required:
      - id
      - username
      - mainEmail
      - otherEmails
      - isAdmin
      - isActive
      - created
    properties:
      id:
        type: integer
        format: int64
      username:
        type: string
      name:
        type: string
      mainEmail:
        type: string
      otherEmails:
        type: array
        items:
          type: string
      isAdmin:
        type: boolean
      isActive:
        type: boolean
      created:
        type: string
        format: date-time
        x-scala-type: java.time.Instant
      intercomHash:
        type: string
    example:
      username: "FooBar"
      name: "Foo"
      mainEmail: "main@codacy.com"
      otherEmails: ["foo@bar.com"]
      isAdmin: false
      isActive: true
      created: "2019-05-07T14:29:13.430Z"
      intercomHash: "userhash"

  UserResponse:
    type: object
    required:
      - data
    properties:
      data:
        $ref: "#/definitions/User"

  UserBody:
    type: object
    properties:
      username:
        type: string
      name:
        type: string
    example:
      username: "FooBar"
      name: "Foo"

  ChangePasswordBody:
    type: object
    required:
      - currentPassword
      - newPassword
    properties:
      currentPassword:
        type: string
      newPassword:
        type: string
    example:
      currentPassword: "current_pass"
      newPassword: "new_pass"

  Organization:
    type: object
    required:
      - name
      - billingEmail
      - provider
    properties:
      name:
        type: string
      billingEmail:
        type: string
      avatar:
        type: string
      created:
        type: string
        format: date-time
        x-scala-type: java.time.Instant
      provider:
        $ref: '#/definitions/Provider'
      joinMode:
        $ref: '#/definitions/JoinMode'
    example:
      name: "FooOrganization"
      billingEmail: "billing@codacy.com"
      avatar: "someRandomLink.com"
      created: "2019-05-07T14:29:13.430Z"
      provider: "gh"
      joinMode: "auto"

  OrganizationListResponse:
    type: object
    required:
      - data
    properties:
      pagination:
        $ref: "#/definitions/PaginationInfo"
      data:
        type: array
        items:
          $ref: "#/definitions/Organization"

  Integration:
    type: object
    required:
      - provider
      - lastAuthenticated
    properties:
      provider:
        $ref: "#/definitions/AccountProvider"
      lastAuthenticated:
        type: string
        format: date-time
        x-scala-type: java.time.Instant
    example:
      name: "FooOrganization"
      lastTimeAuthenticated: "2019-05-07T14:29:13.430Z"

  IntegrationListResponse:
    type: object
    required:
      - data
    properties:
      pagination:
        $ref: "#/definitions/PaginationInfo"
      data:
        type: array
        items:
          $ref: "#/definitions/Integration"

  Repository:
    type: object
    required:
      - owner
      - name
      - visibility
    properties:
      owner:
        type: string
      name:
        type: string
      visibility:
        $ref: "#/definitions/Visibility"
      remoteIdentifier:
        type: string
      lastUpdated:
        type: string
        format: date-time
        x-scala-type: java.time.Instant
    example:
      owner: "codacy"
      name: "codacy-eslint"
      visibility: "Private"
      remoteIdentifier: 3
      lastUpdated: "2019-05-07T14:29:13.430Z"

  RepositoryListResponse:
    type: object
    required:
      - data
    properties:
      pagination:
        $ref: "#/definitions/PaginationInfo"
      data:
        type: array
        items:
          $ref: "#/definitions/Repository"

  ApiToken:
    type: object
    required:
      - id
      - token
    properties:
      id:
        type: integer
        format: int64
      token:
        type: string

  ApiTokenListResponse:
    type: object
    required:
      - data
    properties:
      pagination:
        $ref: "#/definitions/PaginationInfo"
      data:
        type: array
        items:
          $ref: "#/definitions/ApiToken"

  # This is the "interface" for all error responses
  # It should not be used as an error response by itself
  ApiError:
    type: object
    discriminator: error
    required:
      - error
      - message
    properties:
      error:
        type: string
      message:
        type: string

  BadRequest: #400
    allOf:
      - $ref: "#/definitions/ApiError"

  Unauthorized: #401
    allOf:
      - $ref: "#/definitions/ApiError"

  Forbidden: #403
    allOf:
      - $ref: "#/definitions/ApiError"

  NotFound: #404
    allOf:
      - $ref: "#/definitions/ApiError"

  InternalServerError: #500
    allOf:
      - $ref: "#/definitions/ApiError"

responses:
  BadRequest: #400
    description: 'Bad Request'
    x-ms-error-response: true
    schema:
      $ref: "#/definitions/BadRequest"

  Unauthorized: #401
    description: 'Unauthorized'
    x-ms-error-response: true
    schema:
      $ref: "#/definitions/Unauthorized"

  Forbidden: #403
    description: 'Forbidden'
    x-ms-error-response: true
    schema:
      $ref: "#/definitions/Forbidden"

  NotFound: #404
    description: 'Not Found'
    x-ms-error-response: true
    schema:
      $ref: "#/definitions/NotFound"

  InternalServerError: #500
    description: 'Internal Server Error'
    x-ms-error-response: true
    schema:
      $ref: "#/definitions/InternalServerError"

parameters:
  cursorParam: &cursorParam
    in: query
    name: cursor
    required: false
    type: string
    description: "Cursor to list elements after."
    x-example: "Yms345gh=="
    x-ms-parameter-location: 'method'

  limitParam: &limitParam
    in: query
    name: limit
    required: false
    type: integer
    format: int32
    minimum: 1
    maximum: 100
    default: 100
    description: "Number of items to return."
    x-example: 20
    x-ms-parameter-location: 'method'

  accountProviderParam: &accountProviderParam
    in: path
    name: accountProvider
    description: "Account Provider"
    required: true
    type: string
    enum: *accountProviderEnum
    x-example: github
    x-ms-parameter-location: 'method'
    x-ms-enum:
      name: "AccountProvider"

  tokenIdParam: &tokenIdParam
    in: path
    name: tokenId
    description: "Token ID"
    required: true
    type: integer
    format: int64
    x-example: 30
    x-ms-parameter-location: 'method'

  searchParam: &searchParam
    in: query
    name: search
    required: false
    type: string
    description: Filter the results searching by this string.
    x-example: "my-repository-name"
    x-ms-parameter-location: 'method'

  remoteOrganizationNameParam: &remoteOrganizationNameParam
    in: path
    name: remoteOrganizationName
    description: 'Remote organization name'
    required: true
    type: string
    x-example: "codacy"
    x-ms-parameter-location: 'method'

  providerParam: &providerParam
    in: path
    name: provider
    description: "Provider"
    required: true
    type: string
    enum: *providerEnum
    x-example: gh
    x-ms-parameter-location: 'method'
    x-ms-enum:
      name: "Provider"

security:
  - ApiKeyAuth: []

paths:
  /user:
    get:
      tags:
        - account
      summary: Get the authenticated user
      description: Get the authenticated user
      operationId: getUser
      responses:
        '200':
          description: 'Successful operation'
          schema:
            $ref: '#/definitions/UserResponse'
        '401':
          $ref: '#/responses/Unauthorized'
        '500':
          $ref: '#/responses/InternalServerError'
    delete:
      tags:
        - account
      operationId: deleteUser
      parameters:
        - in: body
          name: "ReasonsToDelete"
          required: true
          schema:
            type: array
            items:
              type: string
      responses:
        '204':
          description: 'Successful operation'
        '401':
          $ref: '#/responses/Unauthorized'
        '500':
          $ref: '#/responses/InternalServerError'
    patch:
      tags:
        - account
      operationId: patchUser
      parameters:
        - in: body
          name: "UserBody"
          required: true
          schema:
            $ref: "#/definitions/UserBody"
      responses:
        '200':
          description: 'Successful operation'
          schema:
            $ref: '#/definitions/UserResponse'
        '401':
          $ref: '#/responses/Unauthorized'
        '404':
          $ref: '#/responses/NotFound'
        '500':
          $ref: '#/responses/InternalServerError'

  /user/orgs:
    get:
      tags:
        - account
      summary: List organizations for the authenticated user
      description: List organizations for the authenticated user
      operationId: listUserOrganizations
      parameters:
        - *cursorParam
        - *limitParam
      responses:
        '200':
          description: 'Successful operation'
          schema:
            $ref: '#/definitions/OrganizationListResponse'
        '400':
          $ref: '#/responses/BadRequest'
        '401':
          $ref: '#/responses/Unauthorized'
        '500':
          $ref: '#/responses/InternalServerError'

  /user/integrations:
    get:
      tags:
        - account
      summary: List integrations for the authenticated user
      description: List integrations for the authenticated user
      operationId: listUserIntegrations
      parameters:
        - *cursorParam
        - *limitParam
      responses:
        '200':
          description: 'Successful operation'
          schema:
            $ref: '#/definitions/IntegrationListResponse'
        '400':
          $ref: '#/responses/BadRequest'
        '401':
          $ref: '#/responses/Unauthorized'
        '500':
          $ref: '#/responses/InternalServerError'

  /user/integrations/{accountProvider}:
    delete:
      tags:
        - account
      operationId: deleteIntegration
      parameters:
        - *accountProviderParam
      responses:
        '204':
          description: 'Successful operation'
        '400':
          $ref: '#/responses/BadRequest'
        '401':
          $ref: '#/responses/Unauthorized'
        '404':
          $ref: '#/responses/NotFound'
        '500':
          $ref: '#/responses/InternalServerError'

  /user/repositories:
    get:
      tags:
        - account
      summary: List personal manual repositories for the authenticated user
      description: List personal manual repositories for the authenticated user
      operationId: listPersonalRepositories
      parameters:
        - *cursorParam
        - *limitParam
        - *searchParam
      responses:
        '200':
          description: 'Successful operation'
          schema:
            $ref: '#/definitions/RepositoryListResponse'
        '400':
          $ref: '#/responses/BadRequest'
        '401':
          $ref: '#/responses/Unauthorized'
        '500':
          $ref: '#/responses/InternalServerError'

  /organizations/{provider}/{remoteOrganizationName}/repositories:
    get:
      tags:
        - organization
      summary: List an organization repositories for the authenticated user
      description: List an organization repositories for the authenticated user
      operationId: listOrganizationRepositories
      parameters:
        - *providerParam
        - *remoteOrganizationNameParam
        - *cursorParam
        - *limitParam
        - *searchParam
      responses:
        '200':
          description: 'Successful operation'
          schema:
            $ref: '#/definitions/RepositoryListResponse'
        '400':
          $ref: '#/responses/BadRequest'
        '404':
          $ref: '#/responses/NotFound'
        '500':
          $ref: '#/responses/InternalServerError'

  /user/tokens:
    get:
      tags:
        - account
      summary: Get the authenticated user's API Tokens
      description: Get the authenticated user's API Tokens
      operationId: getUserApiTokens
      parameters:
        - *cursorParam
        - *limitParam
      responses:
        '200':
          description: 'Successful operation'
          schema:
            $ref: '#/definitions/ApiTokenListResponse'
        '400':
          $ref: '#/responses/BadRequest'
        '401':
          $ref: '#/responses/Unauthorized'
        '500':
          $ref: '#/responses/InternalServerError'
    post:
      tags:
        - account
      summary: Create an API Token for the authenticated user
      description: Create an API Token for the authenticated user
      operationId: createUserApiToken
      responses:
        '200':
          description: 'Successful operation'
          schema:
            $ref: '#/definitions/ApiToken'
        '401':
          $ref: '#/responses/Unauthorized'
        '500':
          $ref: '#/responses/InternalServerError'

  /user/tokens/{tokenId}:
    delete:
      tags:
        - account
      summary: Delete an API Token of the authenticated user
      description: Delete an API Token of the authenticated user
      operationId: deleteUserApiToken
      parameters:
        - *tokenIdParam
      responses:
        '204':
          description: 'Successful operation'
        '401':
          $ref: '#/responses/Unauthorized'
        '404':
          $ref: '#/responses/NotFound'
        '500':
          $ref: '#/responses/InternalServerError'

  /user/password:
    post:
      tags:
        - account
      summary: Change the password for the authenticated user
      description: For the authenticated user, validates the current password and changes it to a new one
      operationId: changePassword
      parameters:
        - in: body
          name: "ChangePasswordBody"
          required: true
          schema:
            $ref: "#/definitions/ChangePasswordBody"
      responses:
        '204':
          description: 'Successful operation'
        # This error is thrown when validating the current password
        # At the time of this implementation the team discussed if this should be a 401 Unauthorized:
        #   - This operation validates a password field, implying a security validation on the payload (hence a 401)
        #     - At the same time, 401 is currently used only to encode non-authenticated requests
        #   - 400 can be used as a standard http code for all wrong values in requests
        #     - It also can be seen as too generic given this use case
        # Research on this showed that other APIs return 400 BadRequest in this situation, so we decided for 400
        '400':
          $ref: '#/responses/BadRequest'
        '401':
          $ref: '#/responses/Unauthorized'
        '404':
          $ref: '#/responses/NotFound'
        '500':
          $ref: '#/responses/InternalServerError'

  /health:
    get:
      tags:
        - health
      summary: Health check endpoint
      description: Health check endpoint
      operationId: health
      responses:
        '200':
          description: 'Successful operation'
          schema:
            $ref: '#/definitions/HealthCheckResponse'
          examples:
            application/json: [{ message: "Hello, it's me" }]
        '500':
          $ref: '#/responses/InternalServerError'